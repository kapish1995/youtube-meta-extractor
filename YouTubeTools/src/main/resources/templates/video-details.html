<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Data Retriever</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#2563eb',
                            600: '#1d4ed8',
                            700: '#1d4ed8'
                        },
                        accent: '#22c55e'
                    }
                }
            }
        }
    </script>
    <style>
        .main-title {
            background: linear-gradient(90deg, #2563eb, #22c55e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-header {
            background: linear-gradient(135deg, rgba(37,99,235,.08), rgba(34,197,94,.08));
            border: 1px dashed #e2e8f0;
        }
        .thumb-box {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .desc-box {
            background: rgba(148,163,184,0.12);
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            min-height: 80px;
            white-space: pre-line;
            color: #1e293b;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .tag {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #e2e8f0;
            transition: transform .1s ease, background .2s ease;
        }
        .tag:hover {
            transform: translateY(-1px);
            background: rgba(34, 197, 94, 0.22);
        }
        .error {
            background: rgba(239, 68, 68, 0.12);
            color: #ef4444;
            border-left: 4px solid #ef4444;
        }
        .success {
            background: rgba(16, 185, 129, 0.12);
            color: #10b981;
            border-left: 4px solid #10b981;
        }
        .dark .gradient-header {
            border-color: #334155;
        }
        .dark .thumb-box {
            border-color: #334155;
        }
        .dark .desc-box {
            background: rgba(148,163,184,0.08);
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .tag {
            border-color: #334155;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100">
<div th:replace="~{fragments/navbar :: navbar}" th:with="activePage='video'"></div>
<div class="container mx-auto px-4 max-w-2xl mt-12 pb-12">
    <div class="text-center mb-8">
        <h1 class="main-title text-4xl md:text-5xl font-extrabold mb-4">YouTube Video Data Retriever</h1>
        <div class="gradient-header rounded-xl p-4 mt-6">
            <p class="text-slate-600 dark:text-slate-400 text-lg mb-0">Enter a YouTube video URL or ID to fetch complete video information.</p>
        </div>
    </div>
    <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg p-6 mb-8">
        <form id="detailsForm">
            <label for="videoUrlOrId" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">YouTube Video URL or ID</label>
            <input type="text" id="videoUrlOrId" name="videoUrlOrId" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-800 transition-colors duration-200 mb-4" required>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg shadow-lg transition-colors duration-200" id="fetchBtn">Fetch Video Data</button>
        </form>
        <div id="loading" class="hidden text-center py-4 text-slate-600 dark:text-slate-400">Fetching video details...</div>
        <div id="error" class="error hidden rounded-lg p-4 mt-4"></div>
    </div>
    <div id="result"></div>
    <div id="copySuccess" class="success hidden rounded-lg p-4 mb-4"></div>
</div>
<script>
    const form = document.getElementById('detailsForm');
    const videoUrlOrIdInput = document.getElementById('videoUrlOrId');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const resultDiv = document.getElementById('result');
    const copySuccess = document.getElementById('copySuccess');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        errorDiv.classList.add('hidden');
        resultDiv.innerHTML = '';
        copySuccess.classList.add('hidden');
        loading.classList.remove('hidden');
        const videoUrlOrId = videoUrlOrIdInput.value.trim();
        const videoId = extractVideoId(videoUrlOrId);
        if (!videoId) {
            loading.classList.add('hidden');
            errorDiv.textContent = 'Invalid YouTube URL or ID. Please check and try again.';
            errorDiv.classList.remove('hidden');
            return;
        }
        try {
            const res = await fetch('/api/youtube/video-details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videoId })
            });
            const data = await res.json();
            loading.classList.add('hidden');
            if (!res.ok) {
                errorDiv.textContent = data.message || 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
                return;
            }
            renderResult(data);
        } catch (err) {
            loading.classList.add('hidden');
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('hidden');
        }
    });

    function extractVideoId(urlOrId) {
        if (/^[a-zA-Z0-9_-]{11}$/.test(urlOrId)) return urlOrId;
        const patterns = [
            /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
            /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
            /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/
        ];
        for (const pattern of patterns) {
            const match = urlOrId.match(pattern);
            if (match && match[1]) return match[1];
        }
        return null;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function renderResult(data) {
        if (!data || !data.title) {
            resultDiv.innerHTML = '<div class="error rounded-lg p-4">No video found with this ID.</div>';
            return;
        }
        const fileName = ((data.title || 'thumbnail').replace(/[^a-z0-9]+/gi,'-').toLowerCase().slice(0,60)) + '-thumb.jpg';
        let html = `<div class='bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg p-6'>
            <div class='grid grid-cols-1 lg:grid-cols-2 gap-8'>
                <div>
                    <div class='thumb-box'>
                        <img src='${data.thumbnailUrl}' alt='${data.title}' class='w-full h-auto block'>
                    </div>
                    <div class='mt-4 flex justify-end'>
                        <a class='bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2' href='${data.thumbnailUrl}' download='${fileName}'><i class='bi bi-download'></i> Download</a>
                    </div>
                </div>
                <div>
                    <div class='flex justify-between items-start mb-4'>
                        <h2 class='flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100 m-0'><i class='bi bi-film text-blue-500'></i> ${data.title}</h2>
                        <button class='bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2' onclick="copyToClipboard('${escapeQuotes(data.title)}','Title')"><i class='bi bi-clipboard'></i> Copy</button>
                    </div>
                    <div class='text-slate-600 dark:text-slate-400 mb-4'><i class='bi bi-person-video'></i> ${data.channelTitle} &bull; <i class='bi bi-calendar3 ml-1'></i> ${formatDate(data.publishedAt)}</div>
                    <div class='mb-6'>
                        <div class='flex justify-between items-center mb-2'>
                            <h3 class='flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100 m-0'><i class='bi bi-text-paragraph text-blue-500'></i> Description</h3>
                            <button class='bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2' onclick="copyToClipboard('${escapeQuotes(data.description)}','Description')"><i class='bi bi-clipboard2'></i> Copy</button>
                        </div>
                        <div class='desc-box mt-2'>${data.description ? escapeHtml(data.description) : 'No description available.'}</div>
                    </div>
                    <div>
                        <div class='flex justify-between items-center mb-2'>
                            <h3 class='flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100 m-0'><i class='bi bi-tags text-blue-500'></i> Tags</h3>
                            <button class='bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2' onclick="copyToClipboard('${(data.tags||[]).join(", ").replace(/'/g, "&#39;")}','Tags')" ${(data.tags && data.tags.length) ? '' : 'disabled'}><i class='bi bi-clipboard2-check'></i> Copy All</button>
                        </div>
                        <div class='mt-2'>${(data.tags && data.tags.length > 0) ? data.tags.map(tag => `<span class='tag inline-flex items-center gap-2 rounded-full px-3 py-2 mr-2 mb-2 text-sm'><i class='bi bi-hash'></i>${tag}</span>`).join('') : '<span class="text-slate-500 dark:text-slate-400 italic">No tags available for this video.</span>'}</div>
                    </div>
                </div>
            </div>
        </div>`;
        resultDiv.innerHTML = html;
    }

    function escapeQuotes(str) {
        return (str || '').replace(/'/g, "&#39;").replace(/"/g, '&quot;');
    }
    function escapeHtml(str) {
        return (str || '').replace(/[&<>]/g, function(tag) {
            const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
            return charsToReplace[tag] || tag;
        });
    }

    window.copyToClipboard = function(text, type) {
        navigator.clipboard.writeText(text)
            .then(() => {
                copySuccess.textContent = `${type} copied to clipboard!`;
                copySuccess.classList.remove('hidden');
                setTimeout(() => { copySuccess.classList.add('hidden'); }, 1500);
            })
            .catch(() => {
                alert('Could not copy text.');
            });
    };
</script>
</body>
</html>